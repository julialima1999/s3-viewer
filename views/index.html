<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Leitura do S3</title>
  <link rel="stylesheet" href="/style.css">
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
</head>
<body>
  <h1>üì¶ Dados do S3</h1>

  <div id="charts">
    <canvas id="chart1" width="400" height="200"></canvas>
  </div>

  <h3 class="title">üìú Dados brutos:</h3>
  <pre id="raw-data">Carregando...</pre>

  <script>
    async function carregarDados() {
      try {
        // Captura a parte da URL ap√≥s "/dados/"
        const caminho = window.location.pathname;
        const arquivo = caminho.split('/dados/')[1];

        if (!arquivo) {
          document.getElementById('raw-data').textContent =
            '‚ùå Nenhum arquivo especificado. Use /dados/<arquivo>.';
          return;
        }

        // Faz o fetch din√¢mico do endpoint atual
        const resposta = await fetch(`/dados/${arquivo}`);
        if (!resposta.ok) throw new Error('Erro ao buscar dados do servidor');
        const data = await resposta.json();

        // Mostra o JSON bruto
        document.getElementById('raw-data').textContent = JSON.stringify(data, null, 2);

        // Tentativa de inferir colunas para gr√°fico (igual ao EJS original)
        if (Array.isArray(data) && data.length > 0) {
          const keys = Object.keys(data[0]);
          const labelKey = keys[0];
          const valueKey = keys[1];

          const labels = data.map(item => item[labelKey]);
          const values = data.map(item => Number(item[valueKey]) || 0);

          new Chart(document.getElementById('chart1'), {
            type: 'bar',
            data: {
              labels,
              datasets: [{
                label: valueKey,
                data: values,
                borderWidth: 1
              }]
            },
            options: {
              responsive: true,
              plugins: {
                legend: { display: true },
                title: {
                  display: true,
                  text: `Gr√°fico baseado nas colunas: ${labelKey} x ${valueKey}`
                }
              },
              scales: {
                y: { beginAtZero: true }
              }
            }
          });
        } else {
          document.getElementById('charts').innerHTML =
            "<p style='text-align:center;color:#777;'>Nenhum dado tabular encontrado para gerar gr√°fico.</p>";
        }
      } catch (err) {
        document.getElementById('raw-data').textContent = '‚ùå Erro: ' + err.message;
      }
    }

    carregarDados();
  </script>
</body>
</html>
